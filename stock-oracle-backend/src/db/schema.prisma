generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

model User {
  id         String    @id @default(uuid())
  email      String    @unique
  password   String
  name       String
  role       Role      @default(STAFF)
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  
  moves      Move[]
  
  @@index([email])
}

enum Role {
  ADMIN
  MANAGER
  STAFF
  AUDITOR
}

model Product {
  id           String   @id @default(uuid())
  sku          String   @unique
  name         String
  description  String?
  unit         String   @default("pcs")
  reorderLevel Float    @default(0)
  costPrice    Float?
  sellingPrice Float?
  category     String?
  
  // Vector embedding for semantic search (1536 dimensions for OpenAI)
  embedding    Unsupported("vector(1536)")?
  
  stock        Stock[]
  moveItems    MoveItem[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([name])
  @@index([sku])
}

model Location {
  id        String       @id @default(uuid())
  name      String
  type      LocationType @default(WAREHOUSE)
  address   String?
  capacity  Float?
  
  // Vector embedding for location descriptions
  embedding Unsupported("vector(1536)")?
  
  stock     Stock[]
  movesFrom Move[]       @relation("MoveFrom")
  movesTo   Move[]       @relation("MoveTo")
  users     User[]
  
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  
  @@index([name])
}

enum LocationType {
  WAREHOUSE
  STORE
  PRODUCTION
  TRANSIT
  SUPPLIER
  CUSTOMER
}

model Stock {
  id         String   @id @default(uuid())
  productId  String
  locationId String
  quantity   Float    @default(0)
  
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@unique([productId, locationId])
  @@index([productId])
  @@index([locationId])
}

model Move {
  id             String     @id @default(uuid())
  type           MoveType
  status         MoveStatus @default(DRAFT)
  referenceNo    String?    @unique
  
  fromLocationId String?
  toLocationId   String?
  fromLocation   Location?  @relation("MoveFrom", fields: [fromLocationId], references: [id])
  toLocation     Location?  @relation("MoveTo", fields: [toLocationId], references: [id])
  
  supplier       String?
  customer       String?
  
  notes          String?
  reason         String?    // For adjustments
  
  createdById    String
  createdBy      User       @relation(fields: [createdById], references: [id])
  
  items          MoveItem[]
  
  expectedDate   DateTime?
  completedDate  DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

enum MoveType {
  RECEIPT        // Incoming from supplier
  DELIVERY       // Outgoing to customer
  TRANSFER       // Between locations
  ADJUSTMENT     // Stock count correction
  PRODUCTION     // Manufacturing
  RETURN         // Return from customer
}

enum MoveStatus {
  DRAFT
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model MoveItem {
  id        String  @id @default(uuid())
  moveId    String
  productId String
  quantity  Float
  
  move      Move    @relation(fields: [moveId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([moveId])
  @@index([productId])
}

model Conversation {
  id        String    @id @default(uuid())
  userId    String
  messages  Json      @default("[]")
  context   Json?
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@index([userId])
  @@index([createdAt])
}